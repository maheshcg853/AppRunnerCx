openapi: 3.0.3
info:
  title: EMDB API
  version: 1.0.0
  description: Tenant, Auth, and User APIs for EMDB (pg-promise + PostgreSQL)

servers:
  - url: http://localhost:4000/v1
    description: Local
  - url: https://kf3kgwa3ba.ap-south-1.awsapprunner.com
    description: Dev

tags:
  - name: Tenants
    description: Tenant Management
  - name: Auth
    description: Authentication & Registration
  - name: Users
    description: User Management
  - name: Redis Session
    description: Redis Session Management

paths:
  /tenants:
    get:
      tags: [Tenants]
      summary: Get all tenants
      responses:
        "200":
          description: List of tenants
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Tenant"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      tags: [Tenants]
      summary: Create a Tenant
      description: Creates a new tenant record in the EMDB database.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTenantRequest"
            examples:
              sample:
                value:
                  tenantId: "tenant_001"
                  name: "Helm Corp"
                  updatedBy: "Abdul"
      responses:
        "201":
          description: Tenant created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateTenantResponse"
        "400":
          description: Validation or request error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Duplicate tenant (tenantId already exists)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /tenants/{tenantId}:
    get:
      tags: [Tenants]
      summary: Get a tenant by tenantId
      parameters:
        - name: tenantId
          in: path
          required: true
          description: Tenant identifier (tenants.tenantId)
          schema:
            type: string
            example: tenant_001
      responses:
        "200":
          description: Tenant object
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tenant"
        "404":
          description: Tenant not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TenantNotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/register:
    post:
      tags: [Auth]
      summary: Register a user under a tenant
      description: >
        Creates a new user in a given tenant. Password is hashed on the backend.
        Returns created user (without password) and optionally token if your API supports it.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
            examples:
              sample:
                value:
                  tenantId: "tenant_001"
                  username: "abdul"
                  email: "abdul.s@criskasecurity.com"
                  password: "MyStrongPassword@123"
                  role: "admin"
      responses:
        "201":
          description: User registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Duplicate username/email within the tenant
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Tenant not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/login:
    post:
      tags: [Auth]
      summary: Login a user
      description: Authenticate user and create a server-side session (cookie). Returns session info.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
            examples:
              sample:
                value:
                  username: "john"
                  password: "password123"
                  tenantId: "tenant"
      responses:
        "200":
          description: Login successful (session cookie set)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/logout:
    post:
      tags: [Auth]
      summary: Logout current session
      description: Destroys the current server-side session and clears cookie.
      responses:
        "200":
          description: Logout successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LogoutResponse"
        "400":
          description: Logout failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/me:
    get:
      tags: [Auth]
      summary: Get current authenticated user
      description: Returns the current user stored in session. Requires session cookie.
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /users:
    get:
      tags: [Users]
      summary: Get users (supports filters)
      description: >
        Fetch users. If tenantId is passed, it filters users inside that tenant.
        If username/email are passed, it filters accordingly.
      parameters:
        - name: tenantId
          in: query
          required: false
          schema:
            type: string
            example: tenant_001
        - name: username
          in: query
          required: false
          schema:
            type: string
            example: abdul
        - name: email
          in: query
          required: false
          schema:
            type: string
            example: abdul.s@criskasecurity.com
        - name: role
          in: query
          required: false
          schema:
            type: string
            enum: [admin, event_manager, vendor, customer]
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [ACTIVE, DISABLED]
      responses:
        "200":
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/User"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      tags: [Users]
      summary: Create a user (admin/management)
      description: Creates a user. (If you use /auth/register from FE, you can keep this for internal/admin usage.)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateUserRequest"
            examples:
              sample:
                value:
                  tenantId: "tenant_001"
                  username: "vendor01"
                  email: "vendor01@company.com"
                  password: "SomePassword@123"
                  role: "vendor"
      responses:
        "201":
          description: User created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateUserResponse"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Duplicate username/email within the tenant
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Tenant not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /users/{uid}:
    get:
      tags: [Users]
      summary: Get a single user by uid
      parameters:
        - name: uid
          in: path
          required: true
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        "200":
          description: User object
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /redis-session:
    get:
      tags: [Redis Session]
      summary: Get current session data
      description: Retrieves the current user session data from Redis
      responses:
        "200":
          description: Session data retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionResponse"
        "400":
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    delete:
      tags: [Redis Session]
      summary: Delete session data
      description: Clears the current session from Redis (logout)
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              required: [sessionID]
              properties:
                tenantId:
                  type: string
                  example: abcdef
            examples:
              sample:
                value:
                  sessionID: "abcdef"
      responses:
        "200":
          description: Session deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: string
                    example: "0000"
                  message:
                    type: string
                    example: "Session deleted"
        "400":
          description: Failed to delete session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  schemas:
    # -------------------- TENANTS --------------------
    CreateTenantRequest:
      type: object
      required: [tenantId, name]
      properties:
        tenantId:
          type: string
          minLength: 1
          example: tenant_001
        name:
          type: string
          minLength: 1
          example: Helm Corp
        updatedBy:
          type: string
          example: Abdul

    Tenant:
      type: object
      required: [uid, tenantId, name, status]
      properties:
        uid:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        tenantId:
          type: string
          example: "tenant_001"
        name:
          type: string
          example: "Helm Corp"
        status:
          type: string
          example: "active"
        created_at:
          type: string
          format: date-time
          example: "2025-12-29T10:30:00.000Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-12-29T10:30:00.000Z"
        updatedBy:
          nullable: true
          oneOf:
            - type: string
            - type: "null"

    CreateTenantResponse:
      type: object
      properties:
        message:
          type: string
          example: "Tenant created"
        data:
          $ref: "#/components/schemas/Tenant"

    TenantNotFound:
      type: object
      required: [message]
      properties:
        message:
          type: string
          example: Tenant not found

    # -------------------- AUTH / REGISTER --------------------
    RegisterRequest:
      type: object
      required: [tenantId, username, email, password, role]
      properties:
        tenantId:
          type: string
          minLength: 1
          example: tenant_001
        username:
          type: string
          minLength: 2
          example: abdul
        email:
          type: string
          format: email
          example: abdul.s@criskasecurity.com
        password:
          type: string
          minLength: 8
          example: MyStrongPassword@123
        role:
          type: string
          enum: [admin, event_manager, vendor, customer]
          example: admin

    RegisterResponse:
      type: object
      properties:
        message:
          type: string
          example: "User registered"
        data:
          $ref: "#/components/schemas/User"
        token:
          nullable: true
          description: Present only if your backend returns a JWT on registration
          oneOf:
            - type: string
            - type: "null"

    # -------------------- AUTH / LOGIN --------------------
    LoginRequest:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
          example: username
        password:
          type: string
          example: password123
        tenantId:
          type: string
          example: password

    LoginResponse:
      type: object
      properties:
        message:
          type: string
          example: "Login successful"
        data:
          type: object
          properties:
            sessionID:
              type: string
              example: "abc123def456"
            user:
              $ref: "#/components/schemas/User"

    LogoutResponse:
      type: object
      properties:
        code:
          type: string
          example: "0000"
        message:
          type: string
          example: "Logout successful"

    # -------------------- USERS --------------------
    CreateUserRequest:
      type: object
      required: [tenantId, username, email, password, role]
      properties:
        tenantId:
          type: string
          example: tenant_001
        username:
          type: string
          example: vendor01
        email:
          type: string
          format: email
          example: vendor01@company.com
        password:
          type: string
          minLength: 8
          example: SomePassword@123
        role:
          type: string
          enum: [admin, event_manager, vendor, customer]
          example: vendor

    CreateUserResponse:
      type: object
      properties:
        message:
          type: string
          example: "User created"
        data:
          $ref: "#/components/schemas/User"

    User:
      type: object
      required: [uid, tenant_uid, username, email, role, status, created_at]
      properties:
        uid:
          type: string
          format: uuid
          example: "e5a639a8-7514-4b2b-a775-6af48743a293"
        tenant_uid:
          type: string
          format: uuid
          example: "7f5e0c8e-47a7-46dc-ba0d-3260760bf9d8"
        tenantId:
          type: string
          description: Optional convenience field if your API returns it
          example: "tenant_001"
          nullable: true
        username:
          type: string
          example: abdul
        email:
          type: string
          format: email
          example: abdul.s@criskasecurity.com
        role:
          type: string
          enum: [admin, event_manager, vendor, customer]
          example: admin
        status:
          type: string
          example: active
        created_at:
          type: string
          format: date-time
          example: "2025-12-29T10:30:00.000Z"

    # -------------------- REDIS SESSION --------------------
    SessionResponse:
      type: object
      properties:
        code:
          type: string
          example: "0000"
        message:
          type: string
          example: "Success"
        details:
          type: object
          properties:
            sessionID:
              type: string
              example: "abc123def456ghi789"
            views:
              type: integer
              example: 1
            user:
              type: object
              properties:
                id:
                  type: string
                  example: "u1"
                role:
                  type: string
                  enum: [admin, user, vendor]
                  example: "admin"

    SessionDetailResponse:
      type: object
      properties:
        sessionID:
          type: string
          example: "abc123def456ghi789"
        views:
          type: integer
          example: 5
        session:
          type: object
          description: Full session object with all stored data
          properties:
            views:
              type: integer
              example: 5
            user:
              type: object
              properties:
                id:
                  type: string
                  example: "u1"
                role:
                  type: string
                  example: "admin"

    SessionSaveRequest:
      type: object
      properties:
        user:
          type: object
          required: [id, role]
          properties:
            id:
              type: string
              example: "user-123"
            role:
              type: string
              enum: [admin, user, vendor]
              example: "admin"
            name:
              type: string
              example: "John Doe"
            email:
              type: string
              format: email
              example: "john@example.com"

    # -------------------- ERRORS --------------------
    ErrorResponse:
      type: object
      properties:
        message:
          type: string
          example: Something went wrong
        code:
          nullable: true
          oneOf:
            - type: string
            - type: "null"
        details:
          nullable: true
          oneOf:
            - type: object
            - type: "null"

    Error:
      type: object
      required: [message]
      properties:
        message:
          type: string
          example: Internal server error

  responses:
    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
